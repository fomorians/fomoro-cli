#!/usr/bin/env node

var program = require('commander');
var request = require('request');
var fs = require('fs');
var path = require('path');
var zlib = require('zlib');
var Promise = require('es6-promise').Promise;

var DOWNLOAD_URL = 'http://localhost:3000/download';

var spinner = ['|', '/', '-', '\\'];

program
  .action(function(confpath) {
    var metadata = JSON.parse(fs.readFileSync(confpath));
    // TODO: validate metadata

    var relpath = metadata.dataset || metadata.model;
    var abspath = path.resolve(path.dirname(confpath), relpath);

    if (fs.existsSync(abspath)) {
      console.error('File already exists:', abspath);
      return;
    }

    var req = request({
      url: DOWNLOAD_URL,
      method: 'POST',
      headers: {
        'content-type': 'application/json'
      },
      body: JSON.stringify(metadata)
    });

    var i = 0;
    var total = 0;
    var gunzip = zlib.createGunzip();
    var wstream = fs.createWriteStream(abspath);
    req.on('data', function(chunk) {
      total += chunk.length;
      process.stdout.write('\rdownloading...' + spinner[i] + ' ' + total);
      i++;
      i %= spinner.length;
    });
    req.pipe(gunzip).pipe(wstream);
  })
  .parse(process.argv);
